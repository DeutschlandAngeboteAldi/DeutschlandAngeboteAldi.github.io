<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lidl/Aldi/Rewe Discounts</title>
    <style>
        table {
            border-collapse: collapse;
            width: 80%;
            margin: 20px auto;
        }
        th, td {
            border: 1px solid #aaa;
            padding: 8px 12px;
            text-align: left;
        }
        th {
            background: #f0f0f0;
        }
        .filters {
            width: 80%;
            margin: 20px auto;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .filters input, .filters select {
            padding: 5px;
        }
    </style>
</head>
<body>
    <h2 style="text-align:center;">Shop Discounts</h2>
    <div class="filters">
        <label>
            Shop:
            <select id="filterShop">
                <option value="">All</option>
                <option value="aldi">Aldi</option>
                <option value="lidl">Lidl</option>
                <option value="rewe">Rewe</option>
            </select>
        </label>
        <label>
            Name:
            <input type="text" id="filterName" placeholder="Name">
        </label>
        <label>
            Description:
            <input type="text" id="filterDescription" placeholder="Description">
        </label>
        <label>
            Price Min:
            <input type="number" id="filterPriceMin" min="0" step="0.01" placeholder="Min">
        </label>
        <label>
            Price Max:
            <input type="number" id="filterPriceMax" min="0" step="0.01" placeholder="Max">
        </label>
    </div>
    <table id="discountTable">
        <thead>
            <tr id="tableHeader"></tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
    <script>
        let allData = [];

        // Simple fuzzy match: checks if all characters of pattern appear in order in text
        function fuzzyMatch(pattern, text) {
            pattern = pattern.toLowerCase();
            text = text.toLowerCase();
            let patternIdx = 0, textIdx = 0;
            while (patternIdx < pattern.length && textIdx < text.length) {
                if (pattern[patternIdx] === text[textIdx]) {
                    patternIdx++;
                }
                textIdx++;
            }
            return patternIdx === pattern.length;
        }

        function renderTable(data) {
            // Clear headers and body
            const headerRow = document.getElementById('tableHeader');
            headerRow.innerHTML = '';
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (!Array.isArray(data) || data.length === 0) return;

            // Exclude 'producer' column
            const headers = Object.keys(data[0]).filter(h => h !== 'producer');
            headers.forEach(h => {
                const th = document.createElement('th');
                th.textContent = h.charAt(0).toUpperCase() + h.slice(1);
                headerRow.appendChild(th);
            });

            // Create table rows
            data.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(h => {
                    const td = document.createElement('td');
                    td.textContent = row[h];
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function applyFilters() {
            let filtered = allData.slice();

            const shop = document.getElementById('filterShop').value.trim().toLowerCase();
            const name = document.getElementById('filterName').value.trim();
            const desc = document.getElementById('filterDescription').value.trim();
            const priceMin = parseFloat(document.getElementById('filterPriceMin').value);
            const priceMax = parseFloat(document.getElementById('filterPriceMax').value);

            filtered = filtered.filter(row => {
                // Shop filter
                if (shop && String(row.shop).toLowerCase() !== shop) return false;
                // Name fuzzy filter
                if (name && !fuzzyMatch(name, String(row.name))) return false;
                // Description fuzzy filter
                if (desc && !fuzzyMatch(desc, String(row.description))) return false;
                // Price min filter
                if (!isNaN(priceMin) && parseFloat(row.price) < priceMin) return false;
                // Price max filter
                if (!isNaN(priceMax) && parseFloat(row.price) > priceMax) return false;
                return true;
            });

            renderTable(filtered);
        }

        fetch('data.json')
            .then(response => response.json())
            .then(data => {
                allData = data;
                renderTable(allData);
            })
            .catch(err => {
                document.getElementById('discountTable').outerHTML = "<p style='color:red;text-align:center;'>Failed to load data.json</p>";
            });

        // Add event listeners for filters
        document.addEventListener('DOMContentLoaded', () => {
            ['filterShop', 'filterName', 'filterDescription', 'filterPriceMin', 'filterPriceMax'].forEach(id => {
                document.getElementById(id).addEventListener('input', applyFilters);
            });
        });
    </script>
</body>
</html>
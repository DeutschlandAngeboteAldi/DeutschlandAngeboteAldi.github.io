<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Aldi/Rewe/Edeka/Penny/Lidl Discounts</title>
    <style>
        table {
            border-collapse: collapse;
            width: 80%;
            margin: 20px auto;
        }
        th, td {
            border: 1px solid #aaa;
            padding: 8px 12px;
            text-align: left;
        }
        th {
            background: #f0f0f0;
        }
        .filters {
            width: 80%;
            margin: 20px auto;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .filters input, .filters select {
            padding: 5px;
        }
    </style>
</head>
<body>
    <h2 style="text-align:center;">Shop Discounts</h2>
    <div class="filters">
        <label>
            Shop:
            <select id="filterShop">
                <option value="">All</option>
                <option value="aldi">aldi</option>
                <option value="edeka">edeka</option>
                <option value="penny">penny</option>
                <option value="rewe">rewe</option>
            </select>
        </label>
        <label>
            Name:
            <input type="text" id="filterName" placeholder="Name">
        </label>
        <label>
            Description:
            <input type="text" id="filterDescription" placeholder="Description">
        </label>
        <label>
            Price Min:
            <input type="number" id="filterPriceMin" min="0" step="0.01" placeholder="Min">
        </label>
        <label>
            Price Max:
            <input type="number" id="filterPriceMax" min="0" step="0.01" placeholder="Max">
        </label>
    </div>
    <table id="discountTable">
        <thead>
            <tr id="tableHeader"></tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
    <script>
        let allData = [];

        // Simple fuzzy match: checks if all characters of pattern appear in order in text
        function fuzzyMatch(pattern, text) {
            pattern = pattern.toLowerCase();
            text = text.toLowerCase();
            let patternIdx = 0, textIdx = 0;
            while (patternIdx < pattern.length && textIdx < text.length) {
                if (pattern[patternIdx] === text[textIdx]) {
                    patternIdx++;
                }
                textIdx++;
            }
            return patternIdx === pattern.length;
        }

        function renderTable(data) {
            // Clear headers and body
            const headerRow = document.getElementById('tableHeader');
            headerRow.innerHTML = '';
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (!Array.isArray(data) || data.length === 0) return;

            // Define the headers we want to display
            const headers = ['price', 'discount-percent', 'name', 'description', 'shop'];
            headers.forEach(h => {
                const th = document.createElement('th');
                th.textContent = h.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
                headerRow.appendChild(th);
            });

            // Create table rows
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.price}</td>
                    <td>${row.discount ? row.discount + '%' : ''}</td>
                    <td>${row.name}</td>
                    <td>${row.description}</td>
                    <td>${row.shop}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function applyFilters() {
            let filtered = allData.slice();

            const shop = document.getElementById('filterShop').value.trim().toLowerCase();
            const name = document.getElementById('filterName').value.trim();
            const desc = document.getElementById('filterDescription').value.trim();
            const priceMin = parseFloat(document.getElementById('filterPriceMin').value);
            const priceMax = parseFloat(document.getElementById('filterPriceMax').value);

            // If all filters are empty, or only the shop filter is selected, show no data.
            const otherFiltersActive = name || desc || !isNaN(priceMin) || !isNaN(priceMax);
            if (!otherFiltersActive) {
                renderTable([]);
                return;
            }

            if ((name.length > 0 && name.length < 3) || (desc.length > 0 && desc.length < 3)) {
                renderTable([]);
                return;
            }

            filtered = filtered.filter(row => {
                // Shop filter
                if (shop && String(row.shop).toLowerCase() !== shop) return false;
                if (name.length >= 3 && !fuzzyMatch(name, String(row.name))) return false;
                if (desc.length >= 3 && !fuzzyMatch(desc, String(row.description))) return false;
                // Price min filter
                if (!isNaN(priceMin) && parseFloat(row.price) < priceMin) return false;
                // Price max filter
                if (!isNaN(priceMax) && parseFloat(row.price) > priceMax) return false;
                return true;
            });

            renderTable(filtered.slice(0, 20));
        }

        fetch('http://deutschland-angebote-aldi-lidl-rewe-penny-netto-edeka.s3-website.eu-central-1.amazonaws.com/output.csv') // data.csv
            .then(response => response.text())
            .then(text => {
                const lines = text.trim().split('\n');
                const data = lines.map(line => {
                    if (!line) return null;
                    const [discount, price, name, description, shop] = line.split('â¥Œ');
                    return {
                        price: parseFloat(price),
                        discount: discount ? parseInt(discount, 10) : null,
                        name: name,
                        description: description,
                        shop: shop
                    };
                }).filter(Boolean); // remove any null entries from empty lines

                allData = data;
                applyFilters(); // Initially call filters to ensure table is empty
            })
            .catch(err => {
                console.error('Error fetching or parsing data:', err);
                document.getElementById('discountTable').outerHTML = "<p style='color:red;text-align:center;'>Failed to load data</p>";
            });

        // Add event listeners for filters
        document.addEventListener('DOMContentLoaded', () => {
            renderTable([]); // Ensure table is empty on load
            ['filterShop', 'filterName', 'filterDescription', 'filterPriceMin', 'filterPriceMax'].forEach(id => {
                document.getElementById(id).addEventListener('input', applyFilters);
            });
        });
    </script>
</body>
</html>